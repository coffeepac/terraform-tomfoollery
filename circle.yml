machine:
  post:
    - curl https://releases.hashicorp.com/terraform/0.6.8/terraform_0.6.8_linux_amd64.zip -o ~/terraform.zip
    - sudo unzip terraform.zip -d /usr/local/bin/
    - sudo curl https://s3-us-west-1.amazonaws.com/22acacia-deploy/custom-binaries/terraform-provider-googlecli -o /usr/local/bin/terraform-provider-googlecli
    - sudo chmod +x /usr/local/bin/terraform-provider-googlecli
    - curl https://sdk.cloud.google.com | sudo CLOUDSDK_CORE_DISABLE_PROMPTS=1 bash
    - sudo /opt/google-cloud-sdk/bin/gcloud components install kubectl -q
    - sudo /opt/google-cloud-sdk/bin/gcloud alpha -h < /bin/echo

deployment:
  shitsnacks:
    branch: master
    commands:
      - cd $HOME/$CIRCLE_PROJECT_REPONAME && terraform remote config -backend=s3 -backend-config="access_key=$AWS_ACCESS_KEY_ID" -backend-config="secret_key=$AWS_SECRET_ACCESS_KEY" -backend-config="region=us-west-1" -backend-config="bucket=22acacia-deploy" -backend-config="key=terraform-state/temp2"
      - cd $HOME/$CIRCLE_PROJECT_REPONAME && echo $GOOGLE_CREDENTIALS > account.json
      - cd $HOME/$CIRCLE_PROJECT_REPONAME && terraform plan
      - cd $HOME/$CIRCLE_PROJECT_REPONAME && terraform apply
      - cd $HOME/$CIRCLE_PROJECT_REPONAME && terraform remote push
